from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel, EmailStr
from sqlalchemy.ext.asyncio import AsyncSession
from app.domain.usecases.register_user import RegisterUserUseCase
from app.infrastructure.database.postgres_repository import PostgresUserRepository
from app.infrastructure.security.adapters import BcryptHasher, JwtTokenGenerator
from app.infrastructure.database.session import get_db

router = APIRouter()

# Dependency Injection Factory
def get_register_usecase(db: AsyncSession = Depends(get_db)) -> RegisterUserUseCase:
    repo = PostgresUserRepository(db)
    hasher = BcryptHasher()
    token_gen = JwtTokenGenerator()
    return RegisterUserUseCase(repo, hasher, token_gen)

class RegisterRequest(BaseModel):
    email: EmailStr
    name: str
    password: str

@router.post("/register")
async def register(
    req: RegisterRequest,
    usecase: RegisterUserUseCase = Depends(get_register_usecase)
):
    try:
        result = await usecase.execute(req.email, req.name, req.password)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
