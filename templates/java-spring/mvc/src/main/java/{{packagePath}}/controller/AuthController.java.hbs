package {{packageName}}.controller;

import {{packageName}}.dto.AuthRequest;
import {{packageName}}.dto.AuthResponse;
import {{packageName}}.security.JwtTokenProvider;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    private final JwtTokenProvider tokenProvider;
    private final PasswordEncoder passwordEncoder;

    // In-memory user store (replace with repository in production)
    private final Map<String, Map<String, String>> users = new HashMap<>();

    public AuthController(JwtTokenProvider tokenProvider, PasswordEncoder passwordEncoder) {
        this.tokenProvider = tokenProvider;
        this.passwordEncoder = passwordEncoder;
    }

    @PostMapping("/register")
    public ResponseEntity
    <?> register(@RequestBody AuthRequest request) {
        if (users.containsKey(request.email())) {
            return ResponseEntity.badRequest().body(Map.of("error", "User already exists"));
        }

        String userId = UUID.randomUUID().toString();
        String hashedPassword = passwordEncoder.encode(request.password());

        users.put(request.email(), Map.of(
            "id", userId,
            "email", request.email(),
            "password", hashedPassword
        ));

        String token = tokenProvider.generateToken(userId, request.email());

        return ResponseEntity.ok(new AuthResponse(token, userId, request.email()));
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody AuthRequest request) {
        Map<String, String> user = users.get(request.email());

        if (user == null || !passwordEncoder.matches(request.password(), user.get("password"))) {
            return ResponseEntity.status(401).body(Map.of("error", "Invalid credentials"));
        }

        String token = tokenProvider.generateToken(user.get("id"), user.get("email"));

        return ResponseEntity.ok(new AuthResponse(token, user.get("id"), user.get("email")));
    }

    @GetMapping("/me")
    public ResponseEntity
    <?> me(@RequestHeader("Authorization") String authHeader) {
        // User is already authenticated by JWT filter
        return ResponseEntity.ok(Map.of("message", "Authenticated"));
    }
}