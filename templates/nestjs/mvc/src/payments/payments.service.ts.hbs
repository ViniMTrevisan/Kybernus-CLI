import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import Stripe from 'stripe';
import { PrismaService } from '../prisma/prisma.service';

@Injectable()
export class PaymentsService {
    private stripe: Stripe;

    constructor(
        private configService: ConfigService,
        private prisma: PrismaService,
    ) {
        this.stripe = new Stripe(configService.get('STRIPE_SECRET_KEY', ''), {
            apiVersion: '2024-12-18.acacia',
        });
    }

    async createCheckoutSession(priceId: string, customerId?: string) {
        const session = await this.stripe.checkout.sessions.create({
            mode: 'subscription',
            payment_method_types: ['card'],
            line_items: [{ price: priceId, quantity: 1 }],
            customer: customerId || undefined,
            success_url: `${this.configService.get('FRONTEND_URL')}/success?session_id={CHECKOUT_SESSION_ID}`,
            cancel_url: `${this.configService.get('FRONTEND_URL')}/cancel`,
        });

        return session;
    }

    async handleWebhook(payload: Buffer, signature: string) {
        const webhookSecret = this.configService.get('STRIPE_WEBHOOK_SECRET', '');
        const event = this.stripe.webhooks.constructEvent(payload, signature, webhookSecret);

        switch (event.type) {
            case 'checkout.session.completed':
                {
                    const session = event.data.object as Stripe.Checkout.Session;
                    console.log('Checkout completed:', session.id);
                    // Match the session back to the user via client_reference_id or customer email
                    // await this.prisma.user.update({...});
                }
                break;
            case 'customer.subscription.updated':
                {
                    const subscription = event.data.object as Stripe.Subscription;
                    console.log('Subscription updated:', subscription.id);
                    // Update user's subscription status in DB
                }
                break;
            case 'customer.subscription.deleted':
                {
                    const subscription = event.data.object as Stripe.Subscription;
                    console.log('Subscription deleted:', subscription.id);
                    // Cancel user's subscription in DB
                }
                break;
        }

        return { received: true };
    }
}
